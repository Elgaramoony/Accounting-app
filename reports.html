<div class="header">
    <div>
        <h1>التقارير المالية</h1>
        <div class="breadcrumb">
            <span>الرئيسية</span>
            <i class="fas fa-chevron-left"></i>
            <span>التقارير</span>
        </div>
    </div>
    <div class="user-info">
        <button class="btn btn-primary" onclick="reportsPage.generateReport()">
            <i class="fas fa-chart-bar"></i> إنشاء تقرير
        </button>
        <button class="btn btn-success" onclick="reportsPage.exportAllReports()">
            <i class="fas fa-download"></i> تصدير الكل
        </button>
    </div>
</div>

<!-- شريط التحكم في التقارير -->
<div class="filter-bar">
    <div class="form-row" style="flex: 1;">
        <div class="form-group">
            <label for="reportType">نوع التقرير</label>
            <select id="reportType" class="form-control" onchange="reportsPage.onReportTypeChange()">
                <option value="financial">التقرير المالي</option>
                <option value="sales">تقرير المبيعات</option>
                <option value="expenses">تقرير المصروفات</option>
                <option value="customers">تقرير العملاء</option>
                <option value="tax">التقرير الضريبي</option>
                <option value="profit">تقرير الأرباح والخسائر</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="periodType">الفترة</label>
            <select id="periodType" class="form-control" onchange="reportsPage.onPeriodTypeChange()">
                <option value="today">اليوم</option>
                <option value="yesterday">أمس</option>
                <option value="week">هذا الأسبوع</option>
                <option value="month" selected>هذا الشهر</option>
                <option value="quarter">هذا الربع</option>
                <option value="year">هذه السنة</option>
                <option value="custom">مخصص</option>
            </select>
        </div>
        
        <div class="form-group" id="customDateRange" style="display: none;">
            <div style="display: flex; gap: 10px;">
                <div>
                    <label for="startDate">من تاريخ</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div>
                    <label for="endDate">إلى تاريخ</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="compareWith">مقارنة مع</label>
            <select id="compareWith" class="form-control">
                <option value="">لا يوجد مقارنة</option>
                <option value="previous_period">الفترة السابقة</option>
                <option value="previous_year">نفس الفترة العام الماضي</option>
            </select>
        </div>
    </div>
</div>

<!-- بطاقات النظرة العامة -->
<div class="cards">
    <div class="card">
        <h3>إجمالي الإيرادات</h3>
        <div class="amount" id="totalRevenue">0 ر.س</div>
        <div class="trend" id="revenueTrend">0%</div>
    </div>
    <div class="card revenue">
        <h3>صافي الأرباح</h3>
        <div class="amount" id="netProfit">0 ر.س</div>
        <div class="trend" id="profitTrend">0%</div>
    </div>
    <div class="card success">
        <h3>إجمالي المصروفات</h3>
        <div class="amount" id="totalExpenses">0 ر.س</div>
        <div class="trend" id="expensesTrend">0%</div>
    </div>
    <div class="card warning">
        <h3>هامش الربح</h3>
        <div class="amount" id="profitMargin">0%</div>
        <div class="sub-text">من الإيرادات</div>
    </div>
</div>

<!-- المخططات الرئيسية -->
<div class="charts-grid">
    <div class="chart-container large">
        <div class="chart-header">
            <h3>الإيرادات والمصروفات</h3>
            <select id="revenueChartType" class="form-control" onchange="reportsPage.updateRevenueChart()" style="width: 150px;">
                <option value="line">خطي</option>
                <option value="bar">أعمدة</option>
            </select>
        </div>
        <div class="chart-wrapper">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="chart-header">
            <h3>توزيع الإيرادات</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="incomeDistributionChart"></canvas>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="chart-header">
            <h3>توزيع المصروفات</h3>
        </div>
        <div class="chart-wrapper">
            <canvas id="expensesDistributionChart"></canvas>
        </div>
    </div>
</div>

<!-- التقارير التفصيلية -->
<div class="reports-tabs">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="reportsPage.showTab('financial')">التقرير المالي</button>
        <button class="tab-btn" onclick="reportsPage.showTab('sales')">تقرير المبيعات</button>
        <button class="tab-btn" onclick="reportsPage.showTab('customers')">تقرير العملاء</button>
        <button class="tab-btn" onclick="reportsPage.showTab('tax')">التقرير الضريبي</button>
    </div>
    
    <div class="tab-content active" id="financialTab">
        <div class="table-container">
            <div class="table-header">
                <h3>البيانات المالية التفصيلية</h3>
                <button class="btn btn-sm btn-success" onclick="reportsPage.exportFinancialReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
            </div>
            <div class="table-responsive">
                <table id="financialTable">
                    <thead>
                        <tr>
                            <th>البند</th>
                            <th>المبلغ</th>
                            <th>النسبة</th>
                            <th>المقارنة</th>
                            <th>الاتجاه</th>
                        </tr>
                    </thead>
                    <tbody id="financialData">
                        <!-- سيتم ملء البيانات -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="salesTab">
        <div class="table-container">
            <div class="table-header">
                <h3>تقرير المبيعات</h3>
                <button class="btn btn-sm btn-success" onclick="reportsPage.exportSalesReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
            </div>
            <div class="table-responsive">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>الشهر</th>
                            <th>عدد الفواتير</th>
                            <th>إجمالي المبيعات</th>
                            <th>المبيعات الصافية</th>
                            <th>نمو المبيعات</th>
                            <th>متوسط الفاتورة</th>
                        </tr>
                    </thead>
                    <tbody id="salesData">
                        <!-- سيتم ملء البيانات -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="customersTab">
        <div class="table-container">
            <div class="table-header">
                <h3>تقرير العملاء</h3>
                <button class="btn btn-sm btn-success" onclick="reportsPage.exportCustomersReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
            </div>
            <div class="table-responsive">
                <table id="customersReportTable">
                    <thead>
                        <tr>
                            <th>العميل</th>
                            <th>عدد الفواتير</th>
                            <th>إجمالي المشتريات</th>
                            <th>آخر عملية</th>
                            <th>متوسط الفاتورة</th>
                            <th>الحالة</th>
                        </tr>
                    </thead>
                    <tbody id="customersReportData">
                        <!-- سيتم ملء البيانات -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="taxTab">
        <div class="table-container">
            <div class="table-header">
                <h3>التقرير الضريبي</h3>
                <button class="btn btn-sm btn-success" onclick="reportsPage.exportTaxReport()">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
            </div>
            <div class="table-responsive">
                <table id="taxTable">
                    <thead>
                        <tr>
                            <th>الفترة</th>
                            <th>المبيعات الخاضعة للضريبة</th>
                            <th>مبلغ الضريبة</th>
                            <th>المشتريات الخاضعة للضريبة</th>
                            <th>ضريبة المدخلات</th>
                            <th>صافي الضريبة المستحقة</th>
                        </tr>
                    </thead>
                    <tbody id="taxData">
                        <!-- سيتم ملء البيانات -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- نموذج إنشاء تقرير مخصص -->
<div id="customReportModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>إنشاء تقرير مخصص</h3>
            <button class="close" onclick="reportsPage.closeCustomReport()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="customReportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportName">اسم التقرير *</label>
                        <input type="text" id="reportName" required placeholder="أدخل اسم التقرير">
                    </div>
                    <div class="form-group">
                        <label for="reportFormat">صيغة التقرير</label>
                        <select id="reportFormat">
                            <option value="summary">ملخص</option>
                            <option value="detailed">مفصل</option>
                            <option value="comparative">مقارن</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>اختر البيانات المطلوبة</label>
                    <div class="checkboxes-grid">
                        <label><input type="checkbox" name="dataTypes" value="revenues" checked> الإيرادات</label>
                        <label><input type="checkbox" name="dataTypes" value="expenses" checked> المصروفات</label>
                        <label><input type="checkbox" name="dataTypes" value="invoices"> الفواتير</label>
                        <label><input type="checkbox" name="dataTypes" value="customers"> العملاء</label>
                        <label><input type="checkbox" name="dataTypes" value="taxes"> الضرائب</label>
                        <label><input type="checkbox" name="dataTypes" value="profits"> الأرباح</label>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="groupBy">تجميع حسب</label>
                        <select id="groupBy">
                            <option value="daily">يومي</option>
                            <option value="weekly">أسبوعي</option>
                            <option value="monthly">شهري</option>
                            <option value="quarterly">ربع سنوي</option>
                            <option value="yearly">سنوي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sortBy">ترتيب حسب</label>
                        <select id="sortBy">
                            <option value="date">التاريخ</option>
                            <option value="amount">المبلغ</option>
                            <option value="name">الاسم</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="reportsPage.generateCustomReport()">
                        <i class="fas fa-chart-bar"></i> إنشاء التقرير
                    </button>
                    <button type="button" class="btn" onclick="reportsPage.closeCustomReport()">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.charts-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 25px;
}

.chart-container.large {
    grid-column: span 2;
}

.reports-tabs {
    background: var(--surface);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.tabs-header {
    display: flex;
    background: var(--surface);
    border-bottom: 1px solid var(--border-color);
}

.tab-btn {
    padding: 15px 25px;
    background: none;
    border: none;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: var(--surface);
}

.tab-btn:hover:not(.active) {
    background: var(--surface-hover);
}

.tab-content {
    display: none;
    padding: 0;
}

.tab-content.active {
    display: block;
}

.checkboxes-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 10px;
}

.checkboxes-grid label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    background: var(--surface-hover);
    border-radius: 5px;
    cursor: pointer;
}

.trend-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.trend-up {
    background: #e8f5e8;
    color: #2e7d32;
}

.trend-down {
    background: #ffebee;
    color: #c62828;
}

.trend-neutral {
    background: #f5f5f5;
    color: #616161;
}

/* الوضع الليلي */
.dark-mode .tabs-header {
    background: var(--surface-dark);
    border-bottom-color: var(--border-dark);
}

.dark-mode .tab-btn {
    color: var(--text-secondary-dark);
}

.dark-mode .tab-btn.active {
    color: var(--primary-dark);
    background: var(--surface-dark-2);
}

.dark-mode .checkboxes-grid label {
    background: var(--surface-dark-2);
}

.dark-mode .trend-up {
    background: rgba(76, 175, 80, 0.2);
    color: #81c784;
}

.dark-mode .trend-down {
    background: rgba(244, 67, 54, 0.2);
    color: #ef5350;
}

.dark-mode .trend-neutral {
    background: rgba(97, 97, 97, 0.2);
    color: #bdbdbd;
}
</style>

<script>
// إدارة التقارير
const reportsPage = {
    charts: {},
    currentData: {},
    comparisonData: {},

    async init() {
        await this.loadReportsData();
        await this.initCharts();
        this.setupEventListeners();
    },

    async loadReportsData() {
        try {
            const [invoices, expenses, customers] = await Promise.all([
                AccountingDB.getAll('invoices'),
                AccountingDB.getAll('expenses'),
                AccountingDB.getAll('customers')
            ]);

            this.currentData = { invoices, expenses, customers };
            await this.calculateMetrics();
            this.displayFinancialReport();
            this.displaySalesReport();
            this.displayCustomersReport();
            this.displayTaxReport();
            
        } catch (error) {
            console.error('Error loading reports data:', error);
            this.showError('فشل في تحميل بيانات التقارير');
        }
    },

    async calculateMetrics() {
        const { invoices, expenses } = this.currentData;
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // إجمالي الإيرادات (الفواتير المدفوعة)
        const totalRevenue = invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + inv.total, 0);

        // إجمالي المصروفات
        const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);

        // صافي الأرباح
        const netProfit = totalRevenue - totalExpenses;

        // هامش الربح
        const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;

        // تحديث البطاقات
        document.getElementById('totalRevenue').textContent = AccountingUtils.formatCurrency(totalRevenue);
        document.getElementById('netProfit').textContent = AccountingUtils.formatCurrency(netProfit);
        document.getElementById('totalExpenses').textContent = AccountingUtils.formatCurrency(totalExpenses);
        document.getElementById('profitMargin').textContent = profitMargin.toFixed(1) + '%';

        // حساب الاتجاهات (مبسط)
        this.calculateTrends();
    },

    calculateTrends() {
        // في التطبيق الحقيقي، سيتم حساب الاتجاهات بناءً على البيانات التاريخية
        const revenueTrend = Math.random() * 20 - 10; // -10% إلى +10%
        const profitTrend = Math.random() * 25 - 12; // -12% إلى +13%
        const expensesTrend = Math.random() * 15 - 7; // -7% إلى +8%

        this.updateTrendIndicator('revenueTrend', revenueTrend);
        this.updateTrendIndicator('profitTrend', profitTrend);
        this.updateTrendIndicator('expensesTrend', expensesTrend);
    },

    updateTrendIndicator(elementId, value) {
        const element = document.getElementById(elementId);
        const absValue = Math.abs(value).toFixed(1);
        
        if (value > 0) {
            element.innerHTML = `<i class="fas fa-arrow-up"></i> +${absValue}%`;
            element.className = 'trend up';
        } else if (value < 0) {
            element.innerHTML = `<i class="fas fa-arrow-down"></i> -${absValue}%`;
            element.className = 'trend down';
        } else {
            element.innerHTML = `${absValue}%`;
            element.className = 'trend neutral';
        }
    },

    async initCharts() {
        await this.initRevenueChart();
        await this.initDistributionCharts();
    },

    async initRevenueChart() {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        
        const data = this.prepareRevenueChartData();
        
        this.charts.revenue = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        rtl: true
                    },
                    tooltip: {
                        rtl: true,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${AccountingUtils.formatCurrency(context.raw)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        reverse: true // للغة العربية
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return AccountingUtils.formatCurrency(value);
                            }
                        }
                    }
                }
            }
        });
    },

    prepareRevenueChartData() {
        // بيانات نموذجية للـ 12 شهراً الماضية
        const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                       'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
        
        const revenueData = months.map(() => Math.random() * 100000 + 50000);
        const expensesData = months.map(() => Math.random() * 60000 + 30000);
        const profitData = revenueData.map((rev, idx) => rev - expensesData[idx]);

        return {
            labels: months,
            datasets: [
                {
                    label: 'الإيرادات',
                    data: revenueData,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'المصروفات',
                    data: expensesData,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'صافي الربح',
                    data: profitData,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        };
    },

    async initDistributionCharts() {
        // مخطط توزيع الإيرادات
        const incomeCtx = document.getElementById('incomeDistributionChart').getContext('2d');
        const incomeData = this.prepareIncomeDistributionData();
        
        this.charts.incomeDistribution = new Chart(incomeCtx, {
            type: 'doughnut',
            data: incomeData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        rtl: true
                    }
                }
            }
        });

        // مخطط توزيع المصروفات
        const expensesCtx = document.getElementById('expensesDistributionChart').getContext('2d');
        const expensesData = this.prepareExpensesDistributionData();
        
        this.charts.expensesDistribution = new Chart(expensesCtx, {
            type: 'pie',
            data: expensesData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        rtl: true
                    }
                }
            }
        });
    },

    prepareIncomeDistributionData() {
        const categories = {
            'خدمات استشارية': 45,
            'تطوير برمجيات': 30,
            'صيانة ودعم': 15,
            'تدريب': 10
        };

        return {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12']
            }]
        };
    },

    prepareExpensesDistributionData() {
        const categories = {
            'رواتب': 40,
            'مصاريف مكتب': 15,
            'تسويق': 20,
            'صيانة': 10,
            'مرافق': 8,
            'أخرى': 7
        };

        return {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c']
            }]
        };
    },

    // عرض التقارير
    displayFinancialReport() {
        const tbody = document.getElementById('financialData');
        const { invoices, expenses } = this.currentData;

        const totalRevenue = invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + inv.total, 0);

        const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
        const netProfit = totalRevenue - totalExpenses;
        const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;

        const data = [
            { item: 'إجمالي الإيرادات', amount: totalRevenue, percentage: 100, comparison: '+12%', trend: 'up' },
            { item: 'إجمالي المصروفات', amount: totalExpenses, percentage: (totalExpenses / totalRevenue * 100).toFixed(1), comparison: '+5%', trend: 'up' },
            { item: 'صافي الربح', amount: netProfit, percentage: profitMargin.toFixed(1), comparison: '+18%', trend: 'up' },
            { item: 'تكلفة البضاعة المباعة', amount: totalExpenses * 0.6, percentage: 60, comparison: '+3%', trend: 'up' },
            { item: 'الربح الإجمالي', amount: totalRevenue - (totalExpenses * 0.6), percentage: (40).toFixed(1), comparison: '+15%', trend: 'up' }
        ];

        tbody.innerHTML = data.map(row => `
            <tr>
                <td><strong>${row.item}</strong></td>
                <td>${AccountingUtils.formatCurrency(row.amount)}</td>
                <td>${row.percentage}%</td>
                <td>${row.comparison}</td>
                <td>
                    <span class="trend-indicator trend-${row.trend}">
                        <i class="fas fa-arrow-${row.trend === 'up' ? 'up' : 'down'}"></i>
                        ${row.comparison}
                    </span>
                </td>
            </tr>
        `).join('');
    },

    displaySalesReport() {
        const tbody = document.getElementById('salesData');
        
        // بيانات نموذجية
        const salesData = [
            { month: 'يناير 2024', invoices: 45, totalSales: 150000, netSales: 135000, growth: '+12%', average: 3333 },
            { month: 'فبراير 2024', invoices: 52, totalSales: 168000, netSales: 151200, growth: '+15%', average: 3231 },
            { month: 'مارس 2024', invoices: 48, totalSales: 162000, netSales: 145800, growth: '+8%', average: 3375 },
            { month: 'أبريل 2024', invoices: 55, totalSales: 175000, netSales: 157500, growth: '+18%', average: 3182 },
            { month: 'مايو 2024', invoices: 50, totalSales: 160000, netSales: 144000, growth: '+5%', average: 3200 }
        ];

        tbody.innerHTML = salesData.map(row => `
            <tr>
                <td>${row.month}</td>
                <td>${row.invoices}</td>
                <td>${AccountingUtils.formatCurrency(row.totalSales)}</td>
                <td>${AccountingUtils.formatCurrency(row.netSales)}</td>
                <td>
                    <span class="trend-indicator ${row.growth.includes('+') ? 'trend-up' : 'trend-down'}">
                        ${row.growth}
                    </span>
                </td>
                <td>${AccountingUtils.formatCurrency(row.average)}</td>
            </tr>
        `).join('');
    },

    displayCustomersReport() {
        const tbody = document.getElementById('customersReportData');
        const { customers, invoices } = this.currentData;

        const customerStats = customers.map(customer => {
            const customerInvoices = invoices.filter(inv => inv.customerId === customer.id);
            const totalInvoices = customerInvoices.length;
            const totalPurchases = customerInvoices.reduce((sum, inv) => sum + inv.total, 0);
            const lastInvoice = customerInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            const averageInvoice = totalInvoices > 0 ? totalPurchases / totalInvoices : 0;

            return {
                name: customer.name,
                totalInvoices,
                totalPurchases,
                lastPurchase: lastInvoice ? AccountingUtils.formatDate(lastInvoice.date) : 'لا يوجد',
                averageInvoice,
                status: customer.status
            };
        }).sort((a, b) => b.totalPurchases - a.totalPurchases);

        tbody.innerHTML = customerStats.map(customer => `
            <tr>
                <td><strong>${customer.name}</strong></td>
                <td>${customer.totalInvoices}</td>
                <td>${AccountingUtils.formatCurrency(customer.totalPurchases)}</td>
                <td>${customer.lastPurchase}</td>
                <td>${AccountingUtils.formatCurrency(customer.averageInvoice)}</td>
                <td>
                    <span class="status ${customer.status === 'نشط' ? 'success' : 'warning'}">
                        ${customer.status}
                    </span>
                </td>
            </tr>
        `).join('');
    },

    displayTaxReport() {
        const tbody = document.getElementById('taxData');
        
        // بيانات نموذجية للتقرير الضريبي
        const taxData = [
            { period: 'الربع الأول 2024', taxableSales: 450000, taxAmount: 67500, taxablePurchases: 120000, inputTax: 18000, netTax: 49500 },
            { period: 'الربع الثاني 2024', taxableSales: 520000, taxAmount: 78000, taxablePurchases: 150000, inputTax: 22500, netTax: 55500 },
            { period: 'الربع الثالث 2024', taxableSales: 480000, taxAmount: 72000, taxablePurchases: 130000, inputTax: 19500, netTax: 52500 },
            { period: 'الربع الرابع 2024', taxableSales: 550000, taxAmount: 82500, taxablePurchases: 160000, inputTax: 24000, netTax: 58500 }
        ];

        tbody.innerHTML = taxData.map(row => `
            <tr>
                <td><strong>${row.period}</strong></td>
                <td>${AccountingUtils.formatCurrency(row.taxableSales)}</td>
                <td>${AccountingUtils.formatCurrency(row.taxAmount)}</td>
                <td>${AccountingUtils.formatCurrency(row.taxablePurchases)}</td>
                <td>${AccountingUtils.formatCurrency(row.inputTax)}</td>
                <td><strong>${AccountingUtils.formatCurrency(row.netTax)}</strong></td>
            </tr>
        `).join('');
    },

    // إدارة النماذج والأزرار
    generateReport() {
        this.showModal('customReportModal');
    },

    generateCustomReport() {
        const reportName = document.getElementById('reportName').value;
        if (!reportName) {
            this.showError('يرجى إدخال اسم التقرير');
            return;
        }

        this.showSuccess(`تم إنشاء التقرير "${reportName}" بنجاح`);
        this.closeCustomReport();
        
        // في التطبيق الحقيقي، سيتم إنشاء التقرير بناءً على الإعدادات المحددة
        Auth.logActivity(Auth.getCurrentUser()?.id, 'إنشاء تقرير', 
                        `تم إنشاء تقرير مخصص: ${reportName}`);
    },

    onReportTypeChange() {
        const reportType = document.getElementById('reportType').value;
        this.showTab(reportType);
    },

    onPeriodTypeChange() {
        const periodType = document.getElementById('periodType').value;
        const customDateRange = document.getElementById('customDateRange');
        
        if (periodType === 'custom') {
            customDateRange.style.display = 'block';
        } else {
            customDateRange.style.display = 'none';
        }
        
        // إعادة تحميل البيانات حسب الفترة المحددة
        this.loadReportsData();
    },

    showTab(tabName) {
        // إخفاء جميع المحتويات
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // إلغاء تنشيط جميع الأزرار
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // إظهار المحتوى المحدد
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // تنشيط الزر المحدد
        document.querySelector(`.tab-btn[onclick="reportsPage.showTab('${tabName}')"]`).classList.add('active');
    },

    updateRevenueChart() {
        const chartType = document.getElementById('revenueChartType').value;
        this.charts.revenue.config.type = chartType;
        this.charts.revenue.update();
    },

    // التصدير
    async exportAllReports() {
        try {
            const reports = [
                { name: 'التقرير المالي', data: this.prepareFinancialExport() },
                { name: 'تقرير المبيعات', data: this.prepareSalesExport() },
                { name: 'تقرير العملاء', data: this.prepareCustomersExport() },
                { name: 'التقرير الضريبي', data: this.prepareTaxExport() }
            ];

            for (const report of reports) {
                const csv = this.convertToCSV(report.data);
                AccountingUtils.exportData(csv, `${report.name}_${new Date().toISOString().split('T')[0]}.csv`);
            }

            this.showSuccess('تم تصدير جميع التقارير بنجاح');
            
        } catch (error) {
            console.error('Error exporting reports:', error);
            this.showError('فشل في تصدير التقارير');
        }
    },

    exportFinancialReport() {
        const data = this.prepareFinancialExport();
        const csv = this.convertToCSV(data);
        AccountingUtils.exportData(csv, `financial_report_${new Date().toISOString().split('T')[0]}.csv`);
        this.showSuccess('تم تصدير التقرير المالي بنجاح');
    },

    exportSalesReport() {
        const data = this.prepareSalesExport();
        const csv = this.convertToCSV(data);
        AccountingUtils.exportData(csv, `sales_report_${new Date().toISOString().split('T')[0]}.csv`);
        this.showSuccess('تم تصدير تقرير المبيعات بنجاح');
    },

    exportCustomersReport() {
        const data = this.prepareCustomersExport();
        const csv = this.convertToCSV(data);
        AccountingUtils.exportData(csv, `customers_report_${new Date().toISOString().split('T')[0]}.csv`);
        this.showSuccess('تم تصدير تقرير العملاء بنجاح');
    },

    exportTaxReport() {
        const data = this.prepareTaxExport();
        const csv = this.convertToCSV(data);
        AccountingUtils.exportData(csv, `tax_report_${new Date().toISOString().split('T')[0]}.csv`);
        this.showSuccess('تم تصدير التقرير الضريبي بنجاح');
    },

    // خدمات مساعدة
    prepareFinancialExport() {
        return [
            ['البند', 'المبلغ', 'النسبة', 'المقارنة'],
            ['إجمالي الإيرادات', this.getTotalRevenue(), '100%', '+12%'],
            ['إجمالي المصروفات', this.getTotalExpenses(), '60%', '+5%'],
            ['صافي الربح', this.getNetProfit(), '40%', '+18%']
        ];
    },

    prepareSalesExport() {
        // بيانات نموذجية للتصدير
        return [
            ['الشهر', 'عدد الفواتير', 'إجمالي المبيعات', 'المبيعات الصافية', 'نمو المبيعات'],
            ['يناير 2024', '45', '150,000', '135,000', '+12%'],
            ['فبراير 2024', '52', '168,000', '151,200', '+15%']
        ];
    },

    prepareCustomersExport() {
        const { customers, invoices } = this.currentData;
        return customers.map(customer => {
            const customerInvoices = invoices.filter(inv => inv.customerId === customer.id);
            const totalPurchases = customerInvoices.reduce((sum, inv) => sum + inv.total, 0);
            return [
                customer.name,
                customer.type,
                customerInvoices.length,
                totalPurchases,
                customer.status
            ];
        });
    },

    prepareTaxExport() {
        return [
            ['الفترة', 'المبيعات الخاضعة للضريبة', 'مبلغ الضريبة', 'صافي الضريبة المستحقة'],
            ['الربع الأول 2024', '450,000', '67,500', '49,500'],
            ['الربع الثاني 2024', '520,000', '78,000', '55,500']
        ];
    },

    convertToCSV(data) {
        return data.map(row => 
            row.map(field => `"${field}"`).join(',')
        ).join('\n');
    },

    getTotalRevenue() {
        const { invoices } = this.currentData;
        return invoices
            .filter(inv => inv.status === 'paid')
            .reduce((sum, inv) => sum + inv.total, 0);
    },

    getTotalExpenses() {
        const { expenses } = this.currentData;
        return expenses.reduce((sum, exp) => sum + exp.amount, 0);
    },

    getNetProfit() {
        return this.getTotalRevenue() - this.getTotalExpenses();
    },

    showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    },

    closeCustomReport() {
        document.getElementById('customReportModal').style.display = 'none';
    },

    showSuccess(message) {
        window.accountingApp.showNotification(message, 'success');
    },

    showError(message) {
        window.accountingApp.showNotification(message, 'error');
    },

    showWarning(message) {
        window.accountingApp.showNotification(message, 'warning');
    },

    setupEventListeners() {
        // تحديث البيانات كل دقيقة
        setInterval(() => {
            this.loadReportsData();
        }, 60000);
    }
};
</script>