<div class="header">
    <div>
        <h1>الإعدادات</h1>
        <div class="breadcrumb">
            <span>الرئيسية</span>
            <i class="fas fa-chevron-left"></i>
            <span>الإعدادات</span>
        </div>
    </div>
    <div class="user-info">
        <button class="btn btn-success" onclick="settingsPage.saveAllSettings()">
            <i class="fas fa-save"></i> حفظ جميع الإعدادات
        </button>
    </div>
</div>

<!-- تبويبات الإعدادات -->
<div class="settings-tabs">
    <div class="tabs-sidebar">
        <button class="tab-btn active" onclick="settingsPage.showTab('general')">
            <i class="fas fa-cog"></i> الإعدادات العامة
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('company')">
            <i class="fas fa-building"></i> معلومات الشركة
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('financial')">
            <i class="fas fa-chart-line"></i> الإعدادات المالية
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('tax')">
            <i class="fas fa-receipt"></i> الإعدادات الضريبية
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('users')">
            <i class="fas fa-users"></i> إدارة المستخدمين
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('backup')">
            <i class="fas fa-database"></i> النسخ الاحتياطي
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('notifications')">
            <i class="fas fa-bell"></i> الإشعارات
        </button>
        <button class="tab-btn" onclick="settingsPage.showTab('integrations')">
            <i class="fas fa-plug"></i> التكاملات
        </button>
    </div>
    
    <div class="tabs-content">
        <!-- الإعدادات العامة -->
        <div class="tab-content active" id="generalTab">
            <div class="settings-section">
                <h3><i class="fas fa-language"></i> الإعدادات العامة</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="language">لغة النظام</label>
                        <select id="language">
                            <option value="ar">العربية</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="theme">المظهر</label>
                        <select id="theme" onchange="settingsPage.changeTheme()">
                            <option value="light">فاتح</option>
                            <option value="dark">داكن</option>
                            <option value="auto">تلقائي</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="timezone">المنطقة الزمنية</label>
                        <select id="timezone">
                            <option value="+3">(UTC+3) الرياض</option>
                            <option value="+4">(UTC+4) دبي</option>
                            <option value="+2">(UTC+2) القاهرة</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateFormat">تنسيق التاريخ</label>
                        <select id="dateFormat">
                            <option value="dd/mm/yyyy">يوم/شهر/سنة</option>
                            <option value="mm/dd/yyyy">شهر/يوم/سنة</option>
                            <option value="yyyy-mm-dd">سنة-شهر-يوم</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="currency">العملة الأساسية</label>
                    <select id="currency">
                        <option value="SAR">ريال سعودي (ر.س)</option>
                        <option value="USD">دولار أمريكي ($)</option>
                        <option value="EUR">يورو (€)</option>
                        <option value="AED">درهم إماراتي (د.إ)</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-shield-alt"></i> الأمان</h3>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="twoFactorAuth"> تفعيل المصادقة الثنائية
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sessionTimeout"> إنهاء الجلسة تلقائياً بعد
                    </label>
                    <select id="sessionTimeoutDuration" style="width: 150px; margin-right: 10px;">
                        <option value="30">30 دقيقة</option>
                        <option value="60">60 دقيقة</option>
                        <option value="120">ساعتين</option>
                        <option value="240">4 ساعات</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="passwordPolicy">سياسة كلمات المرور</label>
                    <select id="passwordPolicy">
                        <option value="low">منخفضة (6 أحرف)</option>
                        <option value="medium">متوسطة (8 أحرف، أحرف وأرقام)</option>
                        <option value="high">عالية (10 أحرف، أحرف وأرقام ورموز)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- معلومات الشركة -->
        <div class="tab-content" id="companyTab">
            <div class="settings-section">
                <h3><i class="fas fa-building"></i> معلومات الشركة</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyName">اسم الشركة *</label>
                        <input type="text" id="companyName" required placeholder="اسم الشركة الرسمي">
                    </div>
                    <div class="form-group">
                        <label for="companyLogo">شعار الشركة</label>
                        <input type="file" id="companyLogo" accept="image/*" onchange="settingsPage.previewLogo()">
                        <div class="logo-preview" id="logoPreview"></div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="commercialNumber">السجل التجاري *</label>
                        <input type="text" id="commercialNumber" required placeholder="رقم السجل التجاري">
                    </div>
                    <div class="form-group">
                        <label for="taxNumber">الرقم الضريبي *</label>
                        <input type="text" id="taxNumber" required placeholder="الرقم الضريبي">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="companyAddress">عنوان الشركة *</label>
                    <textarea id="companyAddress" rows="3" required placeholder="العنوان الكامل للشركة"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyPhone">هاتف الشركة *</label>
                        <input type="tel" id="companyPhone" required placeholder="رقم الهاتف">
                    </div>
                    <div class="form-group">
                        <label for="companyEmail">البريد الإلكتروني *</label>
                        <input type="email" id="companyEmail" required placeholder="البريد الإلكتروني الرسمي">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="companyWebsite">الموقع الإلكتروني</label>
                        <input type="url" id="companyWebsite" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label for="companyIndustry">مجال العمل</label>
                        <select id="companyIndustry">
                            <option value="technology">تكنولوجيا</option>
                            <option value="consulting">استشارات</option>
                            <option value="retail">تجارة التجزئة</option>
                            <option value="manufacturing">تصنيع</option>
                            <option value="services">خدمات</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- الإعدادات المالية -->
        <div class="tab-content" id="financialTab">
            <div class="settings-section">
                <h3><i class="fas fa-chart-line"></i> الإعدادات المالية</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="fiscalYearStart">بداية السنة المالية</label>
                        <select id="fiscalYearStart">
                            <option value="1">يناير</option>
                            <option value="7">يوليو</option>
                            <option value="10">أكتوبر</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="accountingMethod">طريقة المحاسبة</label>
                        <select id="accountingMethod">
                            <option value="cash">نقدي</option>
                            <option value="accrual">استحقاق</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="defaultPaymentTerms">شروط الدفع الافتراضية</label>
                    <select id="defaultPaymentTerms">
                        <option value="0">الدفع الفوري</option>
                        <option value="7">7 أيام</option>
                        <option value="15">15 يوماً</option>
                        <option value="30" selected>30 يوماً</option>
                        <option value="45">45 يوماً</option>
                        <option value="60">60 يوماً</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="currencyDecimals">الخانات العشرية للعملة</label>
                    <select id="currencyDecimals">
                        <option value="0">بدون كسور (0)</option>
                        <option value="2" selected>2 خانات عشرية</option>
                        <option value="3">3 خانات عشرية</option>
                    </select>
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-file-invoice"></i> إعدادات الفواتير</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoicePrefix">بادئة رقم الفاتورة</label>
                        <input type="text" id="invoicePrefix" placeholder="INV" style="text-align: left;">
                    </div>
                    <div class="form-group">
                        <label for="invoiceStartingNumber">رقم الفاتورة الابتدائي</label>
                        <input type="number" id="invoiceStartingNumber" value="1001" min="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invoiceNotes">ملاحظات افتراضية على الفواتير</label>
                    <textarea id="invoiceNotes" rows="3" placeholder="ملاحظات تظهر تلقائياً على الفواتير..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoGenerateInvoice" checked> إنشاء أرقام الفواتير تلقائياً
                    </label>
                </div>
            </div>
        </div>
        
        <!-- الإعدادات الضريبية -->
        <div class="tab-content" id="taxTab">
            <div class="settings-section">
                <h3><i class="fas fa-receipt"></i> الإعدادات الضريبية</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="taxEnabled">تفعيل النظام الضريبي</label>
                        <select id="taxEnabled" onchange="settingsPage.toggleTaxSettings()">
                            <option value="false">معطل</option>
                            <option value="true">مفعل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taxType">نوع الضريبة</label>
                        <select id="taxType">
                            <option value="vat">ضريبة القيمة المضافة (VAT)</option>
                            <option value="sales">ضريبة المبيعات</option>
                            <option value="gst">ضريبة السلع والخدمات (GST)</option>
                        </select>
                    </div>
                </div>
                
                <div id="taxSettings" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taxRate">معدل الضريبة (%)</label>
                            <input type="number" id="taxRate" step="0.1" min="0" max="100" value="15">
                        </div>
                        <div class="form-group">
                            <label for="taxNumberDisplay">عرض الرقم الضريبي على الفواتير</label>
                            <select id="taxNumberDisplay">
                                <option value="true">نعم</option>
                                <option value="false">لا</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>المنتجات/الخدمات المعفاة من الضريبة</label>
                        <div class="checkboxes-grid">
                            <label><input type="checkbox" name="taxExempt" value="food"> المواد الغذائية</label>
                            <label><input type="checkbox" name="taxExempt" value="medical"> الخدمات الطبية</label>
                            <label><input type="checkbox" name="taxExempt" value="education"> الخدمات التعليمية</label>
                            <label><input type="checkbox" name="taxExempt" value="books"> الكتب والمطبوعات</label>
                            <label><input type="checkbox" name="taxExempt" value="export"> الصادرات</label>
                            <label><input type="checkbox" name="taxExempt" value="other"> أخرى</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- إدارة المستخدمين -->
        <div class="tab-content" id="usersTab">
            <div class="settings-section">
                <h3><i class="fas fa-users"></i> إدارة المستخدمين</h3>
                
                <div class="table-container">
                    <div class="table-header">
                        <h4>المستخدمون الحاليون</h4>
                        <button class="btn btn-primary btn-sm" onclick="settingsPage.showUserForm()">
                            <i class="fas fa-plus"></i> إضافة مستخدم
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>اسم المستخدم</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الدور</th>
                                    <th>الحالة</th>
                                    <th>آخر نشاط</th>
                                    <th width="120">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="usersData">
                                <!-- سيتم ملء البيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-user-shield"></i> أدوار المستخدمين</h3>
                
                <div class="roles-grid">
                    <div class="role-card">
                        <h4>مدير النظام</h4>
                        <p>صلاحية كاملة على جميع أجزاء النظام</p>
                        <div class="permissions">
                            <span class="permission-badge">جميع الصلاحيات</span>
                        </div>
                    </div>
                    
                    <div class="role-card">
                        <h4>محاسب</h4>
                        <p>إدارة الفواتير والمصروفات والتقارير المالية</p>
                        <div class="permissions">
                            <span class="permission-badge">الفواتير</span>
                            <span class="permission-badge">المصروفات</span>
                            <span class="permission-badge">التقارير</span>
                        </div>
                    </div>
                    
                    <div class="role-card">
                        <h4>مندوب المبيعات</h4>
                        <p>إدارة العملاء وإنشاء الفواتير</p>
                        <div class="permissions">
                            <span class="permission-badge">العملاء</span>
                            <span class="permission-badge">الفواتير</span>
                        </div>
                    </div>
                    
                    <div class="role-card">
                        <h4>مراجع</h4>
                        <p>عرض التقارير والبيانات فقط</p>
                        <div class="permissions">
                            <span class="permission-badge">عرض البيانات</span>
                            <span class="permission-badge">التقارير</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- النسخ الاحتياطي -->
        <div class="tab-content" id="backupTab">
            <div class="settings-section">
                <h3><i class="fas fa-database"></i> النسخ الاحتياطي</h3>
                
                <div class="backup-cards">
                    <div class="backup-card">
                        <div class="backup-icon">
                            <i class="fas fa-cloud-download-alt"></i>
                        </div>
                        <h4>إنشاء نسخة احتياطية</h4>
                        <p>حفظ نسخة من جميع البيانات والإعدادات</p>
                        <button class="btn btn-primary" onclick="settingsPage.createBackup()">
                            <i class="fas fa-download"></i> إنشاء نسخة
                        </button>
                    </div>
                    
                    <div class="backup-card">
                        <div class="backup-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h4>استعادة نسخة احتياطية</h4>
                        <p>استعادة البيانات من نسخة سابقة</p>
                        <input type="file" id="restoreFile" accept=".json" style="display: none;">
                        <button class="btn btn-success" onclick="document.getElementById('restoreFile').click()">
                            <i class="fas fa-upload"></i> استعادة
                        </button>
                    </div>
                    
                    <div class="backup-card">
                        <div class="backup-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <h4>النسخ التلقائي</h4>
                        <p>تفعيل النسخ الاحتياطي التلقائي</p>
                        <label class="switch">
                            <input type="checkbox" id="autoBackup">
                            <span class="slider"></span>
                        </label>
                        <select id="backupFrequency" style="margin-top: 10px;">
                            <option value="daily">يومياً</option>
                            <option value="weekly">أسبوعياً</option>
                            <option value="monthly">شهرياً</option>
                        </select>
                    </div>
                </div>
                
                <div class="backup-history">
                    <h4>سجل النسخ الاحتياطية</h4>
                    <div class="table-responsive">
                        <table id="backupHistoryTable">
                            <thead>
                                <tr>
                                    <th>اسم الملف</th>
                                    <th>الحجم</th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th width="100">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="backupHistoryData">
                                <!-- سيتم ملء البيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- الإشعارات -->
        <div class="tab-content" id="notificationsTab">
            <div class="settings-section">
                <h3><i class="fas fa-bell"></i> إعدادات الإشعارات</h3>
                
                <div class="form-group">
                    <label>أنواع الإشعارات</label>
                    <div class="notifications-list">
                        <label class="notification-item">
                            <input type="checkbox" name="notifications" value="invoice_due" checked>
                            <span class="notification-text">
                                <strong>فواتير مستحقة</strong>
                                <span>إشعار قبل استحقاق الفواتير</span>
                            </span>
                        </label>
                        
                        <label class="notification-item">
                            <input type="checkbox" name="notifications" value="payment_received" checked>
                            <span class="notification-text">
                                <strong>استلام دفعات</strong>
                                <span>عند استلام أي دفعة</span>
                            </span>
                        </label>
                        
                        <label class="notification-item">
                            <input type="checkbox" name="notifications" value="expense_alert">
                            <span class="notification-text">
                                <strong>تنبيهات المصروفات</strong>
                                <span>عند تجاوز ميزانية معينة</span>
                            </span>
                        </label>
                        
                        <label class="notification-item">
                            <input type="checkbox" name="notifications" value="system_updates" checked>
                            <span class="notification-text">
                                <strong>تحديثات النظام</strong>
                                <span>أخبار وتحديثات حول النظام</span>
                            </span>
                        </label>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="emailNotifications">الإشعارات عبر البريد الإلكتروني</label>
                        <select id="emailNotifications">
                            <option value="instant">فورية</option>
                            <option value="daily">ملخص يومي</option>
                            <option value="weekly">ملخص أسبوعي</option>
                            <option value="none">لا شيء</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="pushNotifications">الإشعارات المنبثقة</label>
                        <select id="pushNotifications">
                            <option value="all">جميع الإشعارات</option>
                            <option value="important">المهمة فقط</option>
                            <option value="none">لا شيء</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- التكاملات -->
        <div class="tab-content" id="integrationsTab">
            <div class="settings-section">
                <h3><i class="fas fa-plug"></i> التكاملات والواجهات البرمجية</h3>
                
                <div class="integrations-grid">
                    <div class="integration-card">
                        <div class="integration-header">
                            <img src="/api/placeholder/40/40" alt="ZATCA" class="integration-logo">
                            <h4>الزكاة والضريبة (ZATCA)</h4>
                            <label class="switch">
                                <input type="checkbox" id="zatcaIntegration">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p>التكامل مع نظام الضريبة على القيمة المضافة</p>
                        <div class="integration-status" id="zatcaStatus">غير متصل</div>
                    </div>
                    
                    <div class="integration-card">
                        <div class="integration-header">
                            <img src="/api/placeholder/40/40" alt="Bank" class="integration-logo">
                            <h4>الخدمات المصرفية</h4>
                            <label class="switch">
                                <input type="checkbox" id="bankIntegration">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p>مزامنة الحسابات البنكية تلقائياً</p>
                        <div class="integration-status" id="bankStatus">غير متصل</div>
                    </div>
                    
                    <div class="integration-card">
                        <div class="integration-header">
                            <img src="/api/placeholder/40/40" alt="POS" class="integration-logo">
                            <h4>نقاط البيع (POS)</h4>
                            <label class="switch">
                                <input type="checkbox" id="posIntegration">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p>ربط نظام نقاط البيع بالمحاسبة</p>
                        <div class="integration-status" id="posStatus">غير متصل</div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-key"></i> مفاتيح الواجهة البرمجية (API)</h3>
                    
                    <div class="form-group">
                        <label for="apiKey">مفتاح API الرئيسي</label>
                        <div class="api-key-container">
                            <input type="text" id="apiKey" readonly value="sk_live_xxxxxxxxxxxxxxxxxxxxxxxx" class="readonly-input">
                            <button class="btn btn-sm" onclick="settingsPage.copyApiKey()">
                                <i class="fas fa-copy"></i> نسخ
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="settingsPage.regenerateApiKey()">
                                <i class="fas fa-redo"></i> إعادة توليد
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="apiPermissions">صلاحيات API</label>
                        <div class="checkboxes-grid">
                            <label><input type="checkbox" name="apiPermissions" value="read" checked> قراءة البيانات</label>
                            <label><input type="checkbox" name="apiPermissions" value="write"> كتابة البيانات</label>
                            <label><input type="checkbox" name="apiPermissions" value="delete"> حذف البيانات</label>
                            <label><input type="checkbox" name="apiPermissions" value="reports"> الوصول للتقارير</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نموذج إضافة/تعديل مستخدم -->
<div id="userModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="userModalTitle">إضافة مستخدم جديد</h3>
            <button class="close" onclick="settingsPage.closeUserForm()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="userName">اسم المستخدم *</label>
                    <input type="text" id="userName" required>
                </div>
                
                <div class="form-group">
                    <label for="userEmail">البريد الإلكتروني *</label>
                    <input type="email" id="userEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="userRole">الدور *</label>
                    <select id="userRole" required>
                        <option value="admin">مدير النظام</option>
                        <option value="accountant">محاسب</option>
                        <option value="sales">مندوب مبيعات</option>
                        <option value="viewer">مراجع</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="userStatus">الحالة</label>
                    <select id="userStatus">
                        <option value="active">نشط</option>
                        <option value="inactive">غير نشط</option>
                        <option value="suspended">موقوف</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="userPassword">كلمة المرور *</label>
                    <input type="password" id="userPassword" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">تأكيد كلمة المرور *</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="settingsPage.saveUser()">
                        <i class="fas fa-save"></i> حفظ المستخدم
                    </button>
                    <button type="button" class="btn" onclick="settingsPage.closeUserForm()">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.settings-tabs {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 0;
    background: var(--surface);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow);
}

.tabs-sidebar {
    background: var(--surface);
    border-right: 1px solid var(--border-color);
    padding: 0;
}

.tabs-sidebar .tab-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    width: 100%;
    padding: 15px 20px;
    background: none;
    border: none;
    text-align: right;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-color);
    transition: all 0.3s ease;
}

.tabs-sidebar .tab-btn.active {
    background: var(--primary-color);
    color: white;
}

.tabs-sidebar .tab-btn:hover:not(.active) {
    background: var(--surface-hover);
}

.tabs-content {
    padding: 0;
    max-height: 70vh;
    overflow-y: auto;
}

.tab-content {
    display: none;
    padding: 30px;
}

.tab-content.active {
    display: block;
}

.settings-section {
    background: var(--surface);
    padding: 25px;
    border-radius: 8px;
    margin-bottom: 25px;
    border: 1px solid var(--border-color);
}

.settings-section h3 {
    margin: 0 0 20px 0;
    color: var(--primary-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo-preview {
    margin-top: 10px;
    width: 100px;
    height: 100px;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.logo-preview img {
    max-width: 100%;
    max-height: 100%;
}

.roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.role-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.role-card h4 {
    margin: 0 0 10px 0;
    color: var(--text-color);
}

.role-card p {
    margin: 0 0 15px 0;
    color: var(--text-secondary);
    font-size: 14px;
}

.permissions {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.permission-badge {
    background: var(--surface-hover);
    color: var(--text-color);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.backup-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.backup-card {
    background: var(--surface);
    padding: 25px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    text-align: center;
}

.backup-icon {
    font-size: 48px;
    color: var(--primary-color);
    margin-bottom: 15px;
}

.backup-card h4 {
    margin: 0 0 10px 0;
}

.backup-card p {
    margin: 0 0 20px 0;
    color: var(--text-secondary);
}

.notifications-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.notification-item {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    background: var(--surface-hover);
    border-radius: 8px;
    cursor: pointer;
}

.notification-text {
    flex: 1;
}

.notification-text strong {
    display: block;
    margin-bottom: 5px;
}

.notification-text span {
    font-size: 14px;
    color: var(--text-secondary);
}

.integrations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.integration-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.integration-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.integration-logo {
    width: 40px;
    height: 40px;
    border-radius: 8px;
}

.integration-header h4 {
    flex: 1;
    margin: 0;
}

.integration-card p {
    margin: 0 0 15px 0;
    color: var(--text-secondary);
}

.integration-status {
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
    display: inline-block;
}

.integration-status:not([style*="background"]) {
    background: #ffebee;
    color: #c62828;
}

.api-key-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

.api-key-container input {
    flex: 1;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 24px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(26px);
}

/* الوضع الليلي */
.dark-mode .settings-tabs {
    background: var(--surface-dark);
}

.dark-mode .tabs-sidebar {
    background: var(--surface-dark);
    border-right-color: var(--border-dark);
}

.dark-mode .tabs-sidebar .tab-btn {
    border-bottom-color: var(--border-dark);
    color: var(--text-dark);
}

.dark-mode .tabs-sidebar .tab-btn:hover:not(.active) {
    background: var(--surface-dark-2);
}

.dark-mode .settings-section {
    background: var(--surface-dark);
    border-color: var(--border-dark);
}

.dark-mode .role-card {
    background: var(--surface-dark);
    border-color: var(--border-dark);
}

.dark-mode .permission-badge {
    background: var(--surface-dark-2);
    color: var(--text-dark);
}

.dark-mode .backup-card {
    background: var(--surface-dark);
    border-color: var(--border-dark);
}

.dark-mode .notification-item {
    background: var(--surface-dark-2);
}

.dark-mode .integration-card {
    background: var(--surface-dark);
    border-color: var(--border-dark);
}
</style>

<script>
// إدارة الإعدادات
const settingsPage = {
    currentSettings: {},
    currentUser: null,

    async init() {
        await this.loadSettings();
        await this.loadUsers();
        await this.loadBackupHistory();
        this.setupEventListeners();
    },

    async loadSettings() {
        try {
            const settings = JSON.parse(localStorage.getItem('settings') || '{}');
            this.currentSettings = settings;
            this.populateSettingsForm(settings);
        } catch (error) {
            console.error('Error loading settings:', error);
            this.showError('فشل في تحميل الإعدادات');
        }
    },

    populateSettingsForm(settings) {
        // الإعدادات العامة
        if (settings.language) document.getElementById('language').value = settings.language;
        if (settings.theme) document.getElementById('theme').value = settings.theme;
        if (settings.timezone) document.getElementById('timezone').value = settings.timezone;
        if (settings.dateFormat) document.getElementById('dateFormat').value = settings.dateFormat;
        if (settings.currency) document.getElementById('currency').value = settings.currency;

        // معلومات الشركة
        if (settings.company) {
            document.getElementById('companyName').value = settings.company.name || '';
            document.getElementById('commercialNumber').value = settings.company.commercialNumber || '';
            document.getElementById('taxNumber').value = settings.company.taxNumber || '';
            document.getElementById('companyAddress').value = settings.company.address || '';
            document.getElementById('companyPhone').value = settings.company.phone || '';
            document.getElementById('companyEmail').value = settings.company.email || '';
            document.getElementById('companyWebsite').value = settings.company.website || '';
            document.getElementById('companyIndustry').value = settings.company.industry || '';
            
            if (settings.company.logo) {
                document.getElementById('logoPreview').innerHTML = 
                    `<img src="${settings.company.logo}" alt="شعار الشركة">`;
            }
        }

        // الإعدادات المالية
        if (settings.financial) {
            document.getElementById('fiscalYearStart').value = settings.financial.fiscalYearStart || '1';
            document.getElementById('accountingMethod').value = settings.financial.accountingMethod || 'cash';
            document.getElementById('defaultPaymentTerms').value = settings.financial.defaultPaymentTerms || '30';
            document.getElementById('currencyDecimals').value = settings.financial.currencyDecimals || '2';
        }

        // إعدادات الفواتير
        if (settings.invoices) {
            document.getElementById('invoicePrefix').value = settings.invoices.prefix || '';
            document.getElementById('invoiceStartingNumber').value = settings.invoices.startingNumber || '1001';
            document.getElementById('invoiceNotes').value = settings.invoices.notes || '';
            document.getElementById('autoGenerateInvoice').checked = settings.invoices.autoGenerate !== false;
        }

        // الإعدادات الضريبية
        if (settings.tax) {
            document.getElementById('taxEnabled').value = settings.tax.enabled ? 'true' : 'false';
            document.getElementById('taxType').value = settings.tax.type || 'vat';
            document.getElementById('taxRate').value = settings.tax.rate || '15';
            document.getElementById('taxNumberDisplay').value = settings.tax.showNumber ? 'true' : 'false';
            
            this.toggleTaxSettings();
        }

        // الأمان
        if (settings.security) {
            document.getElementById('twoFactorAuth').checked = settings.security.twoFactorAuth || false;
            document.getElementById('sessionTimeout').checked = settings.security.sessionTimeout || false;
            document.getElementById('sessionTimeoutDuration').value = settings.security.sessionTimeoutDuration || '60';
            document.getElementById('passwordPolicy').value = settings.security.passwordPolicy || 'medium';
        }

        // الإشعارات
        if (settings.notifications) {
            document.getElementById('emailNotifications').value = settings.notifications.email || 'instant';
            document.getElementById('pushNotifications').value = settings.notifications.push || 'all';
            
            // تفعيل أنواع الإشعارات
            const notificationTypes = settings.notifications.types || [];
            document.querySelectorAll('input[name="notifications"]').forEach(checkbox => {
                checkbox.checked = notificationTypes.includes(checkbox.value);
            });
        }

        // التكاملات
        if (settings.integrations) {
            document.getElementById('zatcaIntegration').checked = settings.integrations.zatca || false;
            document.getElementById('bankIntegration').checked = settings.integrations.bank || false;
            document.getElementById('posIntegration').checked = settings.integrations.pos || false;
        }

        // API
        if (settings.api) {
            document.getElementById('apiKey').value = settings.api.key || 'sk_live_xxxxxxxxxxxxxxxxxxxxxxxx';
            
            const permissions = settings.api.permissions || [];
            document.querySelectorAll('input[name="apiPermissions"]').forEach(checkbox => {
                checkbox.checked = permissions.includes(checkbox.value);
            });
        }
    },

    async saveAllSettings() {
        try {
            const settings = this.collectSettingsFromForm();
            
            // حفظ الإعدادات في localStorage
            localStorage.setItem('settings', JSON.stringify(settings));
            this.currentSettings = settings;
            
            // تطبيق بعض الإعدادات فوراً
            this.applyImmediateSettings(settings);
            
            this.showSuccess('تم حفظ جميع الإعدادات بنجاح');
            
            Auth.logActivity(Auth.getCurrentUser()?.id, 'تحديث الإعدادات', 
                            'تم تحديث إعدادات النظام');
            
        } catch (error) {
            console.error('Error saving settings:', error);
            this.showError('فشل في حفظ الإعدادات');
        }
    },

    collectSettingsFromForm() {
        return {
            // الإعدادات العامة
            language: document.getElementById('language').value,
            theme: document.getElementById('theme').value,
            timezone: document.getElementById('timezone').value,
            dateFormat: document.getElementById('dateFormat').value,
            currency: document.getElementById('currency').value,
            
            // معلومات الشركة
            company: {
                name: document.getElementById('companyName').value,
                commercialNumber: document.getElementById('commercialNumber').value,
                taxNumber: document.getElementById('taxNumber').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                industry: document.getElementById('companyIndustry').value,
                logo: document.getElementById('logoPreview').querySelector('img')?.src || null
            },
            
            // الإعدادات المالية
            financial: {
                fiscalYearStart: document.getElementById('fiscalYearStart').value,
                accountingMethod: document.getElementById('accountingMethod').value,
                defaultPaymentTerms: document.getElementById('defaultPaymentTerms').value,
                currencyDecimals: document.getElementById('currencyDecimals').value
            },
            
            // إعدادات الفواتير
            invoices: {
                prefix: document.getElementById('invoicePrefix').value,
                startingNumber: document.getElementById('invoiceStartingNumber').value,
                notes: document.getElementById('invoiceNotes').value,
                autoGenerate: document.getElementById('autoGenerateInvoice').checked
            },
            
            // الإعدادات الضريبية
            tax: {
                enabled: document.getElementById('taxEnabled').value === 'true',
                type: document.getElementById('taxType').value,
                rate: parseFloat(document.getElementById('taxRate').value),
                showNumber: document.getElementById('taxNumberDisplay').value === 'true'
            },
            
            // الأمان
            security: {
                twoFactorAuth: document.getElementById('twoFactorAuth').checked,
                sessionTimeout: document.getElementById('sessionTimeout').checked,
                sessionTimeoutDuration: document.getElementById('sessionTimeoutDuration').value,
                passwordPolicy: document.getElementById('passwordPolicy').value
            },
            
            // الإشعارات
            notifications: {
                email: document.getElementById('emailNotifications').value,
                push: document.getElementById('pushNotifications').value,
                types: Array.from(document.querySelectorAll('input[name="notifications"]:checked'))
                    .map(checkbox => checkbox.value)
            },
            
            // التكاملات
            integrations: {
                zatca: document.getElementById('zatcaIntegration').checked,
                bank: document.getElementById('bankIntegration').checked,
                pos: document.getElementById('posIntegration').checked
            },
            
            // API
            api: {
                key: document.getElementById('apiKey').value,
                permissions: Array.from(document.querySelectorAll('input[name="apiPermissions"]:checked'))
                    .map(checkbox => checkbox.value)
            },
            
            // إعدادات أخرى
            updatedAt: new Date().toISOString(),
            updatedBy: Auth.getCurrentUser()?.id
        };
    },

    applyImmediateSettings(settings) {
        // تطبيق المظهر
        if (settings.theme === 'dark') {
            document.body.classList.add('dark-mode');
        } else if (settings.theme === 'light') {
            document.body.classList.remove('dark-mode');
        } else {
            // تلقائي - يعتمد على إعدادات النظام
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }
        
        // تطبيق اللغة
        document.documentElement.dir = settings.language === 'ar' ? 'rtl' : 'ltr';
        document.documentElement.lang = settings.language;
    },

    // إدارة المستخدمين
    async loadUsers() {
        try {
            const users = await AccountingDB.getAll('users');
            this.displayUsers(users);
        } catch (error) {
            console.error('Error loading users:', error);
            this.showError('فشل في تحميل بيانات المستخدمين');
        }
    },

    displayUsers(users) {
        const tbody = document.getElementById('usersData');
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="customer-avatar" style="width: 32px; height: 32px; font-size: 14px;">
                            ${user.name.charAt(0)}
                        </div>
                        <div>
                            <div style="font-weight: 500;">${user.name}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${user.username}</div>
                        </div>
                    </div>
                </td>
                <td>${user.email}</td>
                <td>
                    <span class="customer-badge ${this.getRoleBadgeClass(user.role)}">
                        ${this.getRoleText(user.role)}
                    </span>
                </td>
                <td>
                    <span class="status ${user.status === 'active' ? 'success' : user.status === 'suspended' ? 'danger' : 'warning'}">
                        ${this.getStatusText(user.status)}
                    </span>
                </td>
                <td>${user.lastLogin ? AccountingUtils.formatDate(user.lastLogin) : 'لم يسجل دخول'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm" onclick="settingsPage.editUser('${user.id}')" title="تعديل">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${user.id !== Auth.getCurrentUser()?.id ? `
                        <button class="btn btn-danger btn-sm" onclick="settingsPage.deleteUser('${user.id}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');
    },

    showUserForm() {
        this.currentUser = null;
        document.getElementById('userModalTitle').textContent = 'إضافة مستخدم جديد';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        
        this.showModal('userModal');
    },

    async saveUser() {
        const form = document.getElementById('userForm');
        if (!form.checkValidity()) {
            this.showError('يرجى ملء جميع الحقول المطلوبة');
            return;
        }

        const password = document.getElementById('userPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password !== confirmPassword) {
            this.showError('كلمات المرور غير متطابقة');
            return;
        }

        const userId = document.getElementById('userId').value;
        const userData = {
            id: userId || 'user_' + Date.now(),
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            username: document.getElementById('userEmail').value.split('@')[0],
            role: document.getElementById('userRole').value,
            status: document.getElementById('userStatus').value,
            password: await Auth.hashPassword(password),
            createdAt: userId ? this.currentUser.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        try {
            if (userId) {
                await AccountingDB.update('users', userId, userData);
            } else {
                await AccountingDB.add('users', userData);
            }

            this.showSuccess(`تم ${userId ? 'تحديث' : 'إضافة'} المستخدم بنجاح`);
            this.closeUserForm();
            await this.loadUsers();
            
        } catch (error) {
            console.error('Error saving user:', error);
            this.showError('فشل في حفظ المستخدم');
        }
    },

    async editUser(id) {
        try {
            this.currentUser = await AccountingDB.get('users', id);
            
            if (!this.currentUser) {
                this.showError('المستخدم غير موجود');
                return;
            }

            document.getElementById('userModalTitle').textContent = 'تعديل المستخدم';
            document.getElementById('userId').value = this.currentUser.id;
            document.getElementById('userName').value = this.currentUser.name;
            document.getElementById('userEmail').value = this.currentUser.email;
            document.getElementById('userRole').value = this.currentUser.role;
            document.getElementById('userStatus').value = this.currentUser.status;
            document.getElementById('userPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            this.showModal('userModal');

        } catch (error) {
            console.error('Error loading user:', error);
            this.showError('فشل في تحميل بيانات المستخدم');
        }
    },

    async deleteUser(id) {
        if (id === Auth.getCurrentUser()?.id) {
            this.showError('لا يمكنك حذف حسابك الخاص');
            return;
        }

        if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
            return;
        }

        try {
            await AccountingDB.delete('users', id);
            this.showSuccess('تم حذف المستخدم بنجاح');
            await this.loadUsers();
            
        } catch (error) {
            console.error('Error deleting user:', error);
            this.showError('فشل في حذف المستخدم');
        }
    },

    // النسخ الاحتياطي
    async createBackup() {
        try {
            const backupData = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                data: {
                    invoices: await AccountingDB.getAll('invoices'),
                    expenses: await AccountingDB.getAll('expenses'),
                    customers: await AccountingDB.getAll('customers'),
                    users: await AccountingDB.getAll('users'),
                    settings: this.currentSettings
                }
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            this.showSuccess('تم إنشاء النسخة الاحتياطية بنجاح');
            
            await this.loadBackupHistory();
            
        } catch (error) {
            console.error('Error creating backup:', error);
            this.showError('فشل في إنشاء النسخة الاحتياطية');
        }
    },

    async loadBackupHistory() {
        // في التطبيق الحقيقي، سيتم تحميل سجل النسخ الاحتياطية من الخادم
        const backupHistory = [
            { name: 'backup_2024-01-15.json', size: '2.3 MB', date: '2024-01-15', type: 'يدوي' },
            { name: 'backup_2024-01-14.json', size: '2.1 MB', date: '2024-01-14', type: 'تلقائي' },
            { name: 'backup_2024-01-13.json', size: '2.0 MB', date: '2024-01-13', type: 'تلقائي' }
        ];

        const tbody = document.getElementById('backupHistoryData');
        tbody.innerHTML = backupHistory.map(backup => `
            <tr>
                <td>${backup.name}</td>
                <td>${backup.size}</td>
                <td>${backup.date}</td>
                <td>${backup.type}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm" onclick="settingsPage.downloadBackup('${backup.name}')" title="تحميل">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="settingsPage.deleteBackup('${backup.name}')" title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    },

    // خدمات مساعدة
    showTab(tabName) {
        // إخفاء جميع المحتويات
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // إلغاء تنشيط جميع الأزرار
        document.querySelectorAll('.tabs-sidebar .tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // إظهار المحتوى المحدد
        document.getElementById(tabName + 'Tab').classList.add('active');
        
        // تنشيط الزر المحدد
        document.querySelector(`.tabs-sidebar .tab-btn[onclick="settingsPage.showTab('${tabName}')"]`).classList.add('active');
    },

    toggleTaxSettings() {
        const taxEnabled = document.getElementById('taxEnabled').value === 'true';
        document.getElementById('taxSettings').style.display = taxEnabled ? 'block' : 'none';
    },

    changeTheme() {
        this.saveAllSettings(); // سيتم تطبيق المظهر تلقائياً عند الحفظ
    },

    previewLogo() {
        const file = document.getElementById('companyLogo').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('logoPreview').innerHTML = 
                    `<img src="${e.target.result}" alt="شعار الشركة">`;
            };
            reader.readAsDataURL(file);
        }
    },

    copyApiKey() {
        const apiKey = document.getElementById('apiKey');
        apiKey.select();
        document.execCommand('copy');
        this.showSuccess('تم نسخ مفتاح API إلى الحافظة');
    },

    regenerateApiKey() {
        if (!confirm('هل أنت متأكد من إعادة توليد مفتاح API؟ سيتم إيقاف جميع التطبيقات التي تستخدم المفتاح الحالي.')) {
            return;
        }

        const newKey = 'sk_live_' + Math.random().toString(36).substr(2, 32);
        document.getElementById('apiKey').value = newKey;
        this.showSuccess('تم إعادة توليد مفتاح API بنجاح');
    },

    getRoleText(role) {
        const roles = {
            'admin': 'مدير النظام',
            'accountant': 'محاسب',
            'sales': 'مندوب مبيعات',
            'viewer': 'مراجع'
        };
        return roles[role] || role;
    },

    getRoleBadgeClass(role) {
        const classes = {
            'admin': 'badge-government',
            'accountant': 'badge-company',
            'sales': 'badge-individual',
            'viewer': 'badge-individual'
        };
        return classes[role] || 'badge-individual';
    },

    getStatusText(status) {
        const statuses = {
            'active': 'نشط',
            'inactive': 'غير نشط',
            'suspended': 'موقوف'
        };
        return statuses[status] || status;
    },

    showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    },

    closeUserForm() {
        document.getElementById('userModal').style.display = 'none';
    },

    showSuccess(message) {
        window.accountingApp.showNotification(message, 'success');
    },

    showError(message) {
        window.accountingApp.showNotification(message, 'error');
    },

    showWarning(message) {
        window.accountingApp.showNotification(message, 'warning');
    },

    setupEventListeners() {
        // حدث تغيير ملف الاستعادة
        document.getElementById('restoreFile').addEventListener('change', (e) => {
            this.restoreBackup(e.target.files[0]);
        });

        // تحديث تلقائي للإعدادات
        setInterval(() => {
            this.loadSettings();
        }, 30000);
    }
};
</script>